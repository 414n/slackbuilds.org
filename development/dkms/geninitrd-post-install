#!/bin/bash

# If an nvidia module has been installed for a previous kernel version,
# update the nvidia kernel module for the new kernel.
#
# Requires: dkms

echo "Checking status of nvidia kernel module ..."

[ -z $KERNEL_VERSION ] && {
  echo "  No KERNEL_VERSION provided. Exiting now."
  exit
}

if [ -x /usr/sbin/dkms ]; then
  # Find existing nvidia module
  NVIDIA_MODULE=$(dkms status |grep nvidia |tail -1|cut -d',' -f1)
  echo "  Found NVIDIA_MODULE = $NVIDIA_MODULE"

  # If there is a previously installed nvidia module
  if [ ! x"$NVIDIA_MODULE" = "x" ]; then

    # Is it already installed for this kernel version?
    if [ ! "$(dkms status -m nvidia -k $KERNEL_VERSION |cut -d' ' -f 4)" = "installed" ]; then
      echo "  Installing NVIDIA_MODULE $NVIDIA_MODULE for kernel version $KERNEL_VERSION"
      dkms install $NVIDIA_MODULE -k $KERNEL_VERSION
    else
      echo "  $NVIDIA_MODULE already installed for kernel $KERNEL_VERSION"
    fi
  fi
fi

